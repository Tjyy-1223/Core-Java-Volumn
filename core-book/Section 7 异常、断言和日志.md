## Section 7  异常、断言和日志

[TOC]

### 7.1 处理错误

在程序出现错误时，用户希望能够用一些理智行为终止，即程序应该：

+  返回到一种安全状态，并能够让用户执行一些其他的命令
+ 允许用户保存所有操作的结果，并以妥善的方式终止程序

**异常处理的任务就是将控制权从错误产生的地方转移给能够处理这种情况的错误处理器。**

哪类问题需要关注：

+ 用户输入错误（输入格式）
+ 设备错误（设备关闭）
+ 物理限制（内存用完）
+ 代码错误

> 如果某个方法不能够采用正常的途径完整它的 任务， 就可以通过另外一个路径退出方法。 在这种情况下， 方法并不返回任何值， 而是抛出 (throw) 一个封装了错误信息的对象。 此外， 调用这个方法的代码也将无法继续执行， 取而代之的是， 异常处理机制开始搜索异常处理器 (exception handler)。

#### 7.1.1 异常分类

在 Java 程序设计语言中， 异常对象都是派生于 Throwable 类的一个实例。 稍后还可以看到， 如果 Java 中内置的异常类不能够满足需求， 用户可以创建自己的异常类。

![image-20230606113919860](./assets/image-20230606113919860.png)

> Error 类描述了 Java 运行时系统的内部错误和资源耗尽错误。如果出现了这样的内部错误，除了通告给用户， 并尽力使程序安全地终止之外，再也无能为力了。这种情况很少出现。

Exception: “如果出现 RuntimeException 异常， 那么就一定是你的问题” 是一条相当有道理的规则。

+ RuntimeException：由程序错误导致的异常
  + 错误的类型转换
  + 数组访问越界
  + 访问 null 指针

+ 其他异常：像I/O错误这类问题导致的异常
  + 试图在文件尾部后面读取数据
  + 试图打开一个不存在的文件
  + 试图根据给定的字符串查找 Class 对象， 而这个字符串表示的类并不存在

> Java 语言规范将派生于 Error 类或 RuntimeException 类的所有异常称为非受查 ( unchecked) 异常，所有其他的异常称为受查(checked) 异常。这是两个很有用的术语，在后面还会用到。编译器将核查是否为所有的受査异常提供了异常处理器。



#### 7.1.2 声明受查异常

如果遇到了无法处理的情况， 那么 Java 的方法可以抛出一个异常。 

> 一个方法不仅需要告诉编译器将要返回什么值， 还要告诉编译器有可能发生什么错误。 例如， 一段读取文件的代码知道有可能读取的文件不存在，代码就需要通知编译器可能会抛出 IOException 类的异常。

方法应该在其首部声明所有可能抛出的异常，这样可以从首部反映出这个方法可能抛出哪类受査异常。 例如， 下面是标准类库中提供的 FilelnputStream 类的一个构造器的声明：

```java
public Fi1elnputStream(String name) throws FileNotFoundException
```

这个声明表示构造器将根据给定的 String 参数产生一个 FilelnputStream 对象， 但也有可能抛出一个异常。如果发生了这种情况， 构造器将不会初始化，而是抛出一个 FileNotFoundException 类对象， 运行时系统开始搜索异常处理器，来处理此异常。

**记住在遇到下面 4 种情况时应该抛出异常:**

+ 调用一个**抛出**受査异常的方法，例如，FilelnputStream 构造器
+ 程序运行过程中发现错误， 并且利用 throw 语句抛出一个受查异常
+ 程序出现错误
+  Java 虚拟机和运行时库出现的内部错误

如果出现前两种情况之一，则必须告诉调用这个方法的程序员有可能抛出异常。 因为任何一个抛出异常的方法都有可能是一个死亡陷阱。如果没有处理器捕获这个异常，当前执行的线程就会结束。

**注释：不需要声明 Java 的内部错误，即从 Error 继承的错误。任何程序代码都具有抛出那些异常的潜能， 而我们对其没有任何控制能力。同样，也不应该声明从 RuntimeException 继承的那些非受查异常。**

> 这些运行时错误完全在我们的控制之下。如果特别关注数组下标引发的错误， 就应该将更多的时间花费在修正程序中的错误上， 而不是说明这些错误发生的可能性上。

**警告：**如果在子类中覆盖了超类的一个方法， 子类方法中声明的受查异常不能比超类方法中声明的异常更通用。 特别需要说明的是， 如果超类方法没有抛出任何受查异常， 子类也不能抛出任何受查异常。



#### 7.1.3 如何抛出异常